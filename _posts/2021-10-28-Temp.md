---
layout: post
mathjax: true
title: zkSNARKs&#58; R1CS and QAP
category: uc

---

{% include mathjax.html %}

Peggy wants to prove to Victor that she knows the solution a particular equation. In order for her to apply zk-SNARKs to prove this, she has to first transform this  into the QAP(Quadratic Arithmetic Progam) form. This page is a write-up on how to do that. It does not touch upon any other parts of zkSNARKs.

Let's use Vitalik Buterin's now famous cubic equation $x^3 + x + 5 == 35$ as the cubic equation Peggy knows the solution to.

If you were to write a program in Python which takes an x value & evaluates the Left Hand Side of this equation, it would look something like this

~~~python

def Evaluate(x):
    return x**3 + x + 5

~~~

We first decompose the above code into a series of much simpler operations. This step is called flattening.
In the flattened code, we are allowed only the following operations 

- Assignment i.e. var1 = var2 or constant
- Operation with an operator var1 = (var2 or constant) Operator (var3 or constant) 
The only operators allowed are +, -, \*, / 

There is no return statement in the flattened code. We just assign the return value instead to a variable "out".

The flattened code 

~~~python

def Evaluate(x):
    var1 = x * x 
    var2 = var1 * x 
    var3 = var2 + x
    out  = var3 + 5
~~~
    

<img class="image-left" alt="Arithmetic Circuit"
    title="Arithmetic Circuit"
    src="https://raw.githubusercontent.com/RisenCrypto/RisenCrypto.github.io/master/images/Circuit.png"
/> 
  
Next, we draw an arithmetic circuit from the above flattened program. As we see from the circut on the right, the circuit has 4 gates representing multiplication & addition operations & also has 5 variables & a constant "5". 

Let's represent the variables in a vector S

$S = [1, x, out, var1, var2, var3]$

"1" is included as an element of the vector so as to represent constants.


**Gate 1**  

Now in the circuit diagram, let's take the first gate which represents $var1 = x * x $

For the purpose of the conversion, we look at it as $x * x = var1$. The Left Hand Side represent the inputs & the Right Hand Side represents the output.
We now represent it as 3 vectors, a, b & c. a & b are the LHS/input vectors & c is the RHS/output vector.

$a = [0, 1, 0, 0, 0, 0]$ (This represents the first term i.e. the x before the multiplication operator - in the circuit, it represents the left side input going into the multiplication gate. Every element of the $a$ vector is 0 except the element corresponding to x which has the value 1 - i.e. 1x)

$b = [0, 1, 0, 0, 0, 0]$ (This is the second term i.e. the x after the multiplication operator - every element of the vector is 0 except the element corresponding to x)

$c = [0, 0, 0, 1, 0, 0]$ (This the output of the multiplication gate. Every element of the vector is 0 except the one corresponding to var1 which is the output of the gate)  

**Gate 2**

Let's take the 2nd gate which represents $var1 * x  = var2$

$a = [0, 0, 0, 1, 0, 0]$ (This represents the first term i.e. the var1 before the multiplication operator. Every element of the a vector is 0 except the element corresponding to var1)

$b = [0, 1, 0, 0, 0, 0]$ (This is the second term i.e. x - every element of the vector is 0 except the element corresponding to x)

$c = [0, 0, 0, 0, 1, 0]$ (This the output of the multiplication operation- i.e. var2. Every element of the vector is 0 except the one corresponding to var2)

**Gate 3**

3rd gate is the addition gate which represents $var2 + x = var3$. The vectors for addition gates are derived differently. The equation is equivalent to $(var2 + x) * 1 = var3$. So the 'a' vector represents $var2 + x$, the 'b' vector represents '1' & the 'c' vector represents var3

$a = [0, 1, 0, 0, 1, 0]$ (This represents $var2 + x$)

$b = [1, 0, 0, 0, 0, 0]$ (This represents 1)

$c = [0, 0, 0, 0, 0, 1]$ (This represents var3)

**Gate 4**

Likewise, the 4th gate $var3 + 5 = out$ is equivalent to $(var3 + 5) * 1 = out$ 

$a = [5, 0, 0, 0, 0, 1]$ ($var3 + 5$)

$b = [1, 0, 0, 0, 0, 0]$ ($1$)

$c = [0, 0, 1, 0, 0, 0]$ ($out$)

We can create a Matrix A by using each of 'a' vectors as a row in the Matrix. Likewise Matrices B & C.

$$A = 
\begin{pmatrix} 
    0&1&0&0&0&0 \\
    0&0&0&1&0&0 \\
    0&1&0&0&1&0 \\
    5&0&0&0&0&1 \\
\end{pmatrix}$$

$$B =
\begin{pmatrix} 
0&1&0&0&0&0 \\
0&1&0&0&0&0 \\
1&0&0&0&0&0 \\
1&0&0&0&0&0 \\
\end{pmatrix}$$

$$C = 
\begin{pmatrix} 
0&0&0&1&0&0 \\
0&0&0&0&1&0 \\
0&0&0&0&0&1 \\
0&0&1&0&0&0 \\
\end{pmatrix}$$

This also with our vector $S = [1, x, out, var1, var2, var3]$ forms our R1CS.
A correct solution for $x$ will satisfy the constraint $A.S + B.S = C.S$

**R1CS to QAP**

We have 12 vectors of length 6. We have to transform these to 6 groups of 3 degree 3 polynomials. 

Each column of A, B & C has 4 elements. Each such column can be converted into a polynomial of Degree 3 using Lagrange's Polynomial Interpolation.

For e.g. 1st column of A is [0, 0, 0, 5] (transposed). We can consider each element as the y-coordinate of x corresponding to 1, 2, 3, 4. So we get 4 sets of points - (1,0), (2,0), (3,0), (4,5)

We well Lagrange interpolate them using sagemath


