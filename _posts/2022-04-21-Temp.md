---
layout: post
mathjax: true
title: Cofactor clearing in composite order Elliptic Curves
category: uc

---

{% include mathjax.html %}

Many cryptographic protocols use elliptic curves of prime order. However there are composite order curves like the Edwards Curve, Montgomery Curves which easily provide faster group operations with complete addition laws which are not vulnerable to a timing attack. So many modern elliptic curve implentations use a composite order curve with a small co-factor. The order of these curves is  $h.p$ where $p$ is a prime & $h$ is a small cofactor usually $8$ or lesser. The composite order curve has a subgroup of prime order $p$ which is used for the implementations. Though these curves have a lot of advantages, there are also some disadvantages one of which we discuss below called as a small subgroup attack.

## Small Subgroup attack in non-prime order curves

The operations are usually implemented in the prime order subgroup of the full Curve. Let's take the example of Diffie Hellman to understand the small subgroup attack. Let's say our curve is of order $8p$ where $p$ is a prime & $8$ is the cofactor. Let $G$ be a generator of the prime order subgroup. Let $a$ & $b$ be Alice's & Bob's private keys respective. This is how a typical Diffie Hellman key exchange works.

$$
\text{Alice} \xrightarrow{\hspace{3cm} a G \hspace{3cm}} \text{Bob} \\
\text{Alice} \xleftarrow{\hspace{3cm} b G \hspace{3cm}} \text{Bob}
$$

Alice calculates $a.bG$, Bob calculates $b.aG$ and the shared secret is derived from $abG$ by both parties.

Now if Bob was a malicious player (i.e. Mallory) he can launch a small subgroup attack which can leak some information about Alice's private key. The protocol depends on operating in the prime order subgroup (i.e. the subgroup of order $p$). However the curve curve also contains other subgroups - one of which is of order $8$. The points of the subgroup of order $8$ are not in the prime order subgroup (other than the identity). Lets say $H$ is a **generator** of the subgroup of order $8$. Now, Bab instead of sending $bG$ to Alice sends $H$ to Alice. So Alice calculates $aH$ & derives the share secret using that. Alice then encrypts a message using the shared secret & sends it to Bob. Now if Alice's share secret had been derived from $abG$, then number of possible values $abG$ could have is $p$ which is a very large prime - for e.g. for $ed25519$, $p = 2^{252} + 27742317777372353535851937790883648493$ so brute forcing is not possible. However, since Bob has made Alice derive her shared secret from $aH$, it's much simpler. Since $H$ is a generator of subgroup of order $8$, $aH$ is a point of the subgroup of order $8$ because of closure in the subgroup. Now brute forcing the secret key is much simpler for Bob since it's now based on only one of $8$ points. Which of the $8$ points $aH$ depends $a \bmod 8$, so this leaks info about the lower 3 bits of $a$. 

There are also a couple of other similar attacks 

- Instead of sending $bG$, Bob can send $bG + H$ to Alice. So Alice now calculates $abG + aH$. Now since Bob knows $abG$, this again leaks $a \bmod 8$ which is the lower 3 bits of $a$.

- Instead of Bob launching the above attack, if Bob is a honest player but a man in the middle (Mallory) intercepts $bG$ sent by Bob & replaces it with $H$, then he can brute force the secret key generated by Alice ($aH$) because it can only be one of $8$ points.

The above attack is limited to Diffie Hellman, but also applicable to many other Cryptographic protocols like Signature validation etc. The small subgroup attack has very bad effects on some protocols like PAKE, MQV etc.


## Mitigation for the small subgroup attack - Cofactor clearing



